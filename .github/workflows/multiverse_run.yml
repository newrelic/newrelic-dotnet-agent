name: Run the MultiverseScanner

on:
  workflow_call:
    inputs:
      agentVersion:
        description: 'Agent version being tested'
        default: '0.0.0.0'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      agentVersion:
        description: 'Agent version being tested'
        default: '0.0.0.0'
        required: true

env:
  DOTNET_NOLOGO: true

jobs:
  build-run-publish-multiverse-testing:
    name: Build and Publish Multiverse Testing Suite
    runs-on: windows-2019
    continue-on-error: true
    
    env:
      multiverse_path: ${{ github.workspace }}\tests\Agent\MultiverseTesting
      multiverse_solution: ${{ multiverse_path }}\MultiverseTesting.sln
      multiverse_consolescanner_path: ${{ multiverse_path }}\ConsoleScanner\bin\Release\netcoreapp3.1
      multiverse_reportbuilder_path: ${{ multiverse_path }}\ReportBuilder\bin\Release\netcoreapp3.1
      MVS_XML_PATH: ${{ github.workspace }}\src\Agent\NewRelic\Agent\Extensions\Providers\Wrapper

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Cache Multiverse Testing Suite
        id: cache-multiverse
        uses: actions/cache@v2
        with:
          path: ${{ env.multiverse_path }}
          key: multiverse-${{ hashFiles('**/tests/Agent/MultiverseTesting') }}

      - name: Add msbuild to PATH
        if: steps.cache-multiverse.outputs.cache-hit != 'true'
        uses: microsoft/setup-msbuild@v1

      - name: Build MultiverseTesting.sln
        if: steps.cache-multiverse.outputs.cache-hit != 'true'
        run: |
          Write-Host "List NuGet Sources"
          dotnet nuget list source # For unknown reasons, this step is necessary to avoid subsequent problems with NuGet package restore
          Write-Host "MSBuild.exe -restore -m -p:Configuration=Release -p:AllowUnsafeBlocks=true ${{ env.multiverse_solution }}"
          MSBuild.exe -restore -m -p:Configuration=Release -p:AllowUnsafeBlocks=true ${{ env.multiverse_solution }}
        shell: powershell

      - name: Setup .NET Core 3.1.100
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.100'

      - name: Run ConsoleScanner
        run: |
          cd ${{ env.multiverse_consolescanner_path }}
          .\ConsoleScanner.exe ".\config.yml" ".\reports.yml"
        shell: powershell

      - name: Upload Reports
        uses: actions/upload-artifact@v2
        with:
          name: mvs-reports
          path: ${{ env.multiverse_consolescanner_path }}\reports.yml
          if-no-files-found: error

      - name: Run ReportBuilder
        run: |
          cd ${{ env.multiverse_reportbuilder_path }}
          .\ReportBuilder.exe "${{ inputs.agentVersion }}" "${{ env.multiverse_consolescanner_path }}\reports.yml" "${{ github.workspace }}\docs\mvs"
        shell: powershell

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages
          folder: .