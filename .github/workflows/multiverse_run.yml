name: Run the MultiverseScanner

on:
  workflow_run:
    workflows: ['.NET Agent All Solutions Build']
    types: ['completed']

env:
  DOTNET_NOLOGO: true

jobs:

  get-info:
    name: "Get information about the source run"
    runs-on: ubuntu-latest
    outputs:
      sourceEvent: ${{ steps.source-run-info.outputs.sourceEvent }}
    steps:
      - name: "Get information about the origin 'CI' run"
        uses: potiuk/get-workflow-origin@v1
        id: source-run-info
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          sourceRunId: ${{ github.event.workflow_run.id }}

  get-s3-artifacts:
    needs: get-info
    if: ${{ needs.get-info.outputs.sourceEvent == 'release' }}
    name: Get and Publish S3 Artifacts Locally
    runs-on: ubuntu-latest
    steps:
      - name: Dependencies
        run: sudo apt install -y unzip
        shell: bash

      - name: Download S3 Artifacts
        run:  curl https://multiverse-testing.s3-us-west-2.amazonaws.com/MultiverseTesting.zip -O
        shell: bash
      
      - name: Extract files
        run: unzip MultiverseTesting.zip
        shell: bash
      
      - name: Upload Locally
        uses: actions/upload-artifact@v2
        with:
          name: mvs
          path: ${{ github.workspace }}/netcoreapp3.1
          if-no-files-found: error
    
  run-mvs:
    needs: get-s3-artifacts
    name: Run the MultiverseScanner
    runs-on: windows-2019

    env:
      MVS_XML_PATH: ${{ github.workspace }}\src\Agent\NewRelic\Agent\Extensions\Providers\Wrapper

    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Download S3 Artifacts
        uses: actions/download-artifact@v2
        with:
          name: mvs
          path: ${{ github.workspace }}

      - name: Setup .NET Core 3.1.100
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.100'

      - name: Run ConsoleScanner
        run: |
          .\ConsoleScanner.exe ".\config.yml" ".\reports.yml"
        shell: powershell

      - name: Upload Reports
        uses: actions/upload-artifact@v2
        with:
          name: mvs-reports
          path: ${{ github.workspace }}\reports.yml
          if-no-files-found: error

  run-reportbuilder:
    needs: [get-s3-artifacts, run-mvs]
    name: Run the ReportBuilder
    runs-on: windows-2019

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: 'gh-pages'
          fetch-depth: 0
      
      - name: Download S3 Artifacts
        uses: actions/download-artifact@v2
        with:
          name: mvs
          path: ${{ github.workspace }}

      - name: Download report Artifacts
        uses: actions/download-artifact@v2
        with:
          name: mvs-reports
          path: ${{ github.workspace }}
      
      - name: Download agent-version Artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: all_solutions.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: agent-version
          path: ${{ github.workspace }}
          repo: ${{ github.repository }}

      - name: Setup .NET Core 3.1.100
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.100'

      - name: Run ConsoleScanner
        run: |
          $agentVersion = Get-Content .\agent_version.txt | Select-Object -first 1
          .\ReportBuilder.exe "$agentVersion" ".\reports.yml" ".\docs\mvs"
        shell: powershell

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@4.1.4
        with:
          branch: gh-pages
          folder: .