name: build_download_site_index_files
run-name: Indexing ${{ inputs.bucket }}/${{ inputs.prefix }} in ${{inputs.aws-region}} (dry-run=${{inputs.dry-run}}) by @${{ github.actor }}

on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID:
        description: 'AWS Access Key ID'
        required: true
      AWS_SECRET_ACCESS_KEY:
        description: 'AWS Secret Access Key'
        required: true
      MT_TEST_BUCKET_NAME:
        description: 's3 bucket to build index.html for'
        required: true
    inputs:
      aws-region:
        description: 'AWS region s3 bucket is in'
        required: true
        type: string
      prefix:
        description: 'object prefix to build index.html for'
        required: false
        type: string
      dry-run:
        description: 'See what index.html will be generated without uploading them to the bucket'
        required: false
        default: true
        type: boolean  
  workflow_dispatch:
    inputs:
      aws-region:
        description: 'AWS region s3 bucket is in'
        required: true
        type: string
      prefix:
        description: 'object prefix to build index.html for'
        required: false
        type: string
      dry-run:
        description: 'See what index.html will be generated without uploading them to the bucket'
        required: false
        default: true
        type: boolean  

jobs:
  s3-build-index:
    name: Build index.html files
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/newrelic/s3indexer
    steps:
      - name: Uncover secret
        run: echo -n "${{ secrets.BUCKET_NAME }}" >> foo && cut -c1-3 foo && cut -c4
      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-region: ${{ inputs.aws-region }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Update index.html files in AWS S3 bucket
        env:
          BUCKET_NAME: ${{ secrets.MT_TEST_BUCKET_NAME }}        
        run: |
          if [ ${{ inputs.dry-run }} = true ]; then
            echo "dry run, inputs.dry-run=[${{ inputs.dry-run }}]"
            echo "bucket name: $BUCKET_NAME"
            /opt/nr/bin/s3-indexer -bucket $BUCKET_NAME -prefix "${{ inputs.prefix }}"
          else
            echo "upload, inputs.dry-run=[${{ inputs.dry-run }}]"
            /opt/nr/bin/s3-indexer -bucket $BUCKET_NAME -prefix "${{ inputs.prefix }}" -upload
          fi
