name: Get Release Checksums

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of the Release Workflow (all_solutions.yml) that was triggered by creating a Release in GitHub.  ID can be found in URL for run.'
        required: true

env:
  DOTNET_NOLOGO: true

jobs:

  get-release-checksums:
    name: Get Deploy Artifacts and output release checksum information
    runs-on: ubuntu-latest
    steps:
      - name: Download Deploy Artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: all_solutions.yml
          run_id: ${{ github.event.inputs.run_id }}
          name: deploy-artifacts
          path: ${{ github.workspace }}
          repo: ${{ github.repository }}

      - name: Check file existence
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: "${{ github.workspace }}/build/BuildArtifacts/DownloadSite/SHA256/checksums.md"
          ignore_case: false

      - name: File exists
        if: steps.check_files.outputs.files_exists == 'true'
        # Only runs if all of the files exists
        run: echo The file exists!

      - name: Read file
        id: read_file
        run: |
          file_contents=$(cat ${{ github.workspace }}/build/BuildArtifacts/DownloadSite/SHA256/checksums.md)
          echo "::set-output name=file_contents::$file_contents"

      - name: Use file contents
        run: |
          contents="${{ steps.read_file.outputs.file_contents }}"
          echo "File contents: $contents"

      - name: Get Release Checksum
        run: |        
          checksumFilePath="${{ github.workspace }}/build/BuildArtifacts/DownloadSite/SHA256/checksums.md"
          echo "checksumFilePath=$checksumFilePath"

          echo "cat just the file:"
          cat /home/runner/work/newrelic-dotnet-agent/newrelic-dotnet-agent/build/BuildArtifacts/DownloadSite/SHA256/checksums.md
          
          echo "cat and pipe to echo:"
          cat $filePath | echo

          echo "echo just the cat:"
          echo "$(cat $filePath)"

          echo "echo the cat and send to github output:"
          echo "$(cat $filePath)" >> $GITHUB_OUTPUT
        shell: bash