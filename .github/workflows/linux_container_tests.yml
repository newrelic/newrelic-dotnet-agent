name: Linux Container Integration Tests

on:
  workflow_call:
    inputs:
      external_call:
        type: boolean
        default: true
        required: false
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of the build workflow (all_solutions.yml) to use the agent from. ID can be found in URL for run.'
        required: true

env:
  DOTNET_NOLOGO: true
  NR_DEV_BUILD_HOME: false
  # Static list of all Distro trait values present in Container Integration Tests
  CONTAINER_TEST_DISTROS: Debian,Ubuntu,Alpine,Centos,Amazon,Fedora


# only allow one instance of this workflow to be running per PR or branch, cancels any that are already running
concurrency:
  group: linux-container-tests-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:

  linux-container-tests:
    name: Container Test (${{ matrix.distro }}/${{ matrix.arch }})
    # Runner chosen per matrix entry
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # amd64 distros (all test types)
          - arch: amd64
            distro: Debian
            runner: ubuntu-latest
          - arch: amd64
            distro: Ubuntu
            runner: ubuntu-latest
          - arch: amd64
            distro: Alpine
            runner: ubuntu-latest
          - arch: amd64
            distro: Centos
            runner: ubuntu-latest
          - arch: amd64
            distro: Amazon
            runner: ubuntu-latest
          - arch: amd64
            distro: Fedora
            runner: ubuntu-latest
          # arm64 distros (subset of tests implemented)
          - arch: arm64
            distro: Debian
            runner: ubuntu-24.04-arm
          - arch: arm64
            distro: Ubuntu
            runner: ubuntu-24.04-arm
          - arch: arm64
            distro: Amazon
            runner: ubuntu-24.04-arm
          - arch: arm64
            distro: Fedora
            runner: ubuntu-24.04-arm

    env:
      test_results_path: tests\TestResults
      integration_tests_shared_project: ${{ github.workspace }}/tests/Agent/IntegrationTests/Shared
      NR_DOTNET_TEST_SAVE_WORKING_DIRECTORY: 1
      # Make this variable true to enable extra data-gathering and logging to help troubleshoot test failures, at the cost of additional time and resources
      enhanced_logging: false

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Download Agent Home Folders (Call)
        if: ${{ inputs.external_call }}
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: homefolders
          path: src/Agent

      - name: Download Agent Home Folders (Dispatch)
        if: ${{ !inputs.external_call }}
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.run_id }}
          name: homefolders
          path: ${{ github.workspace }}/src/Agent
          repository: ${{ github.repository }}

      - name: Set up secrets
        env:
          INTEGRATION_TEST_SECRETS: ${{ secrets.TEST_SECRETS }}
        run: |
          echo $INTEGRATION_TEST_SECRETS | dotnet user-secrets set --project ${{ env.integration_tests_shared_project }}

      - name: Install .NET 9
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: '9.0.x'

      - name: Build & Run Linux Container Integration Tests
        env:
          BUILD_ARCH: ${{ matrix.arch }}
        run: >-
          dotnet test ./tests/Agent/IntegrationTests/ContainerIntegrationTests/ContainerIntegrationTests.csproj
          --framework net9.0
          --filter "Architecture=${{ matrix.arch }}&Distro=${{ matrix.distro }}"
          --logger "console;verbosity=detailed"
          --logger "trx;verbosity=detailed"
          --results-directory ${{ env.test_results_path }}

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ContainerTestResults-${{ matrix.arch }}-${{ matrix.distro }}
          path: ${{ env.test_results_path }}
