name: Deploy the New Relic Azure Site Extension

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of the Release Workflow (siteextension_release.yml) that was triggered by creating a Release in GitHub.  ID can be found in URL for run.'
        required: true
      deploy:
        description: 'If "true", deploy the artifacts. If "false", do everything except deploy.'
        required: true
        default: 'false'

env:
  DOTNET_NOLOGO: true

permissions:
  actions: read
  contents: read

jobs:

  deploy-nuget:
    name: Deploy to NuGet
    runs-on: windows-2022
    permissions:
      id-token: write #enable GitHub OIDC token issuance for this job

    env:
      nuget_source: https://www.nuget.org

    steps:
      - name: Download Deploy Artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ inputs.run_id }}
          name: deploy-artifacts
          path: ${{ github.workspace }}
          repository: ${{ github.repository }}

      # Get a short-lived NuGet API key
      - name: NuGet login (OIDC â†’ temp API key)
        uses: NuGet/login@d22cc5f58ff5b88bf9bd452535b4335137e24544 # v1.1.0
        id: login
        with:
          user: ${{ secrets.NUGET_TRUSTED_PUBLISH_POLICY_USER }}

      - name: Deploy New Relic Azure Site Extension to Nuget
        run: |
          $packageName = Get-ChildItem ${{ github.workspace }}\build\BuildArtifacts\AzureSiteExtension\NewRelic.Azure.WebSites.Extension.*.nupkg -Name
          $packagePath = Convert-Path ${{ github.workspace }}\build\BuildArtifacts\AzureSiteExtension\$packageName
          if ("${{ inputs.deploy }}" -eq "true") {
            dotnet nuget push $packagePath --api-key "${{ steps.login.outputs.NUGET_API_KEY }}" --source ${{ env.nuget_source }}
          }
          else {
            Write-Host "Input:deploy was not true (${{ inputs.deploy }}).  The following deploy command was not run:"
            Write-Host "dotnet nuget push $packagePath --source ${{ env.nuget_source }}"
          }
        shell: powershell
